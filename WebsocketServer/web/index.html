<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>åœ¨çº¿èŠå¤©</title>

    <link rel="stylesheet" href="/public/materialize.min.css">
    <link rel="stylesheet" href="/public/MaterialIcons">
    <link rel="stylesheet" href="/public/emojione.min.css"/>
    <link rel="stylesheet" href="/public/style.css">

</head>
<body>
<header>
    <nav>
        <div class="nav-wrapper">
            <a href="/" class="brand-logo left">åœ¨çº¿èŠå¤©</a>
        </div>
    </nav>
</header>
<main id="app">
    <div class="row">
        <div class="col s9">
            <div class="card horizontal">
                <div id="chat-messages" class="card-content" v-html="chatContent">
                </div>
            </div>
        </div>
        <div class="col s3">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">åœ¨çº¿ç”¨æˆ·</span>
                    <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
                    <div class="connection-status" style="margin-bottom: 10px;">
                        <span class="badge" :class="{
                            'green': connectionStatus === 'connected',
                            'yellow': connectionStatus === 'connecting' || connectionStatus === 'reconnecting',
                            'red': connectionStatus === 'disconnected'
                        }">
                            {{ getStatusText() }}
                        </span>
                        <button v-if="connectionStatus === 'disconnected'" 
                                class="btn-small waves-effect waves-light" 
                                @click="manualReconnect"
                                style="margin-left: 10px;">
                            é‡è¿
                        </button>
                    </div>
                    <ul class="collection">
                        <li class="collection-item" v-for="user in onlineUsers" :key="user.userid">
                            {{ user.userphone }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="row" v-if="joined">
        <div class="input-field col s6">
            <input type="text" v-model="newMsg" @keyup.enter="send" placeholder="è¾“å…¥æ¶ˆæ¯... (è¾“å…¥ @ai æˆ– /ai ä¸AIå¯¹è¯)">
        </div>
        <div class="input-field col s1">
            <button class="waves-effect waves-light btn-small blue" @click="sendAIMessage" style="width: 100%;" title="AIå¯¹è¯">
                <i class="material-icons">smart_toy</i>
            </button>
        </div>
        <div class="input-field col s2">
            <input type="file" id="fileInput" ref="fileInput" @change="onFileSelect" style="display: none;" multiple>
            <button class="waves-effect waves-light btn-small" @click="selectFile" style="width: 100%;">
                <i class="material-icons">attach_file</i>
            </button>
        </div>
        <div class="input-field col s2">
            <button class="waves-effect waves-light btn-small" @click="showFileList" style="width: 100%;" title="æ–‡ä»¶åˆ—è¡¨">
                <i class="material-icons">folder</i>
            </button>
        </div>
        <div class="input-field col s1">
            <button class="waves-effect waves-light btn-small red" @click="testDelete" style="width: 100%;" title="æµ‹è¯•åˆ é™¤">
                <i class="material-icons">delete</i>
            </button>
        </div>
        <div class="input-field col s1">
            <button class="waves-effect waves-light btn" @click="send">
                å‘é€
            </button>
        </div>
    </div>

    <!-- AIä½¿ç”¨æç¤º -->
    <div class="row" v-if="joined">
        <div class="col s12">
            <div class="ai-suggestion">
                <strong>ğŸ’¡ AIå¯¹è¯æç¤ºï¼š</strong> è¾“å…¥ <code>@ai ä½ å¥½</code> æˆ– <code>/ai ä½ å¥½</code> ä¸AIå¯¹è¯ï¼Œæˆ–ç‚¹å‡»è“è‰²æœºå™¨äººæŒ‰é’®å¿«é€Ÿæé—®
            </div>
        </div>
    </div>
    
    <!-- æ–‡ä»¶ä¸Šä¼ è¿›åº¦ -->
    <div class="row" v-if="uploadingFiles.length > 0">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">æ–‡ä»¶ä¸Šä¼ è¿›åº¦</span>
                    <div v-for="file in uploadingFiles" :key="file.id" class="file-upload-item">
                        <div class="file-info">
                            <span class="file-name">{{ file.name }}</span>
                            <span class="file-size">{{ formatFileSize(file.size) }}</span>
                            <span v-if="file.isResuming" class="resume-badge">æ–­ç‚¹ç»­ä¼ </span>
                            <span v-if="file.isInstant" class="instant-badge">ç§’ä¼ </span>
                        </div>
                        <div class="progress">
                            <div class="determinate" :style="{width: file.progress + '%'}"></div>
                        </div>
                        <div class="file-status">
                            {{ file.status }}
                            <span v-if="file.uploadedChunks > 0" class="chunk-info">
                                ({{ file.uploadedChunks }}/{{ file.chunks }} åˆ†å—)
                            </span>
                        </div>
                        <div v-if="file.status === 'ä¸Šä¼ å¤±è´¥'" class="file-actions">
                            <button class="btn-small waves-effect waves-light" @click="retryUpload(file)">
                                <i class="material-icons">refresh</i> é‡è¯•
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ–‡ä»¶åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div id="fileListModal" class="modal">
        <div class="modal-content">
            <h4>æ–‡ä»¶åˆ—è¡¨</h4>
            <div v-if="fileList.length === 0" class="center-align" style="padding: 20px;">
                <p>æš‚æ— æ–‡ä»¶</p>
            </div>
            <div v-else class="file-list">
                <div v-for="file in fileList" :key="file.id" class="file-item">
                    <div class="file-info">
                        <i class="material-icons">{{ getFileIcon(file.file_name) }}</i>
                        <span class="file-name">{{ file.file_name }}</span>
                        <span class="file-size">{{ formatFileSize(file.file_size) }}</span>
                        <span class="file-date">{{ formatDate(file.created_at) }}</span>
                    </div>
                    <div class="file-actions">
                        <button class="btn-small waves-effect waves-light" @click="downloadFile(file.file_name)" title="ä¸‹è½½">
                            <i class="material-icons">download</i>
                        </button>
                        <button class="btn-small waves-effect waves-light red" @click="deleteFile(file.file_name)" title="åˆ é™¤">
                            <i class="material-icons">delete</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="waves-effect waves-green btn-flat" @click="closeModal">å…³é—­</button>
        </div>
    </div>
    <div class="row" v-if="!joined">
        <div class="input-field col s8">
            <input type="text" v-model.trim="username" placeholder="å–ä¸ªæ˜µç§°å§">
        </div>
        <div class="input-field col s4">
            <button class="waves-effect waves-light btn" @click="join()">
                åŠ å…¥
            </button>
        </div>
    </div>
</main>
<footer class="page-footer">
</footer>
<script src="/public/vue.min.js"></script>
<script src="/public/js/emojione.min.js"></script>
<script src="/public/js/jquery-2.1.1.min.js"></script>
<script src="/public/js/md5.js"></script>
<script src="/public/js/materialize.min.js"></script>
<script src="/public/app.js"></script>
</body>
</html>